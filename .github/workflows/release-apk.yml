name: Android Signed Release (APK)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          validate-wrappers: false

      - name: Prepare signing keystore
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail

          if [[ -z "${ANDROID_KEYSTORE_BASE64}" ]]; then
            echo "Missing secret ANDROID_KEYSTORE_BASE64" >&2
            exit 1
          fi

          echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > mjc-jm-release.keystore

          printf "storeFile=../mjc-jm-release.keystore\nstorePassword=%s\nkeyAlias=%s\nkeyPassword=%s\n" \
            "${ANDROID_KEYSTORE_PASSWORD}" \
            "${ANDROID_KEY_ALIAS}" \
            "${ANDROID_KEY_PASSWORD}" \
            > keystore.properties

      - name: Build signed release APK
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ./gradlew
          ./gradlew :app:assembleRelease

      - name: Create update.json
        shell: bash
        env:
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          APK_PATH="$(find app/build/outputs/apk/release -maxdepth 1 -name '*.apk' | head -n 1)"
          if [[ -z "${APK_PATH}" ]]; then
            echo "Release APK not found" >&2
            find app/build/outputs -maxdepth 4 -type f -name '*.apk' -print >&2 || true
            exit 1
          fi

          # Ensure stable asset name for releases/latest/download
          cp "${APK_PATH}" ./mjc-jm.apk

          SHA256="$(sha256sum ./mjc-jm.apk | awk '{print $1}')"

          BUILD_TOOLS_VERSION="$(ls "${ANDROID_HOME}/build-tools" | sort -V | tail -n 1)"
          AAPT="${ANDROID_HOME}/build-tools/${BUILD_TOOLS_VERSION}/aapt"

          VERSION_NAME="$(${AAPT} dump badging ./mjc-jm.apk | sed -n "s/.*versionName='\([^']*\)'.*/\1/p" | head -n 1)"
          VERSION_CODE="$(${AAPT} dump badging ./mjc-jm.apk | sed -n "s/.*versionCode='\([^']*\)'.*/\1/p" | head -n 1)"

          if [[ -z "${VERSION_NAME}" || -z "${VERSION_CODE}" ]]; then
            echo "Failed to read versionName/versionCode from APK" >&2
            exit 1
          fi

          cat > update.json <<EOF
          {"versionCode":${VERSION_CODE},"versionName":"${VERSION_NAME}","apkUrl":"https://github.com/${REPO}/releases/latest/download/mjc-jm.apk","sha256":"${SHA256}"}
          EOF

      - name: Publish GitHub Release assets
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          # Create release if missing; then upload (overwrite) assets
          gh release view "${TAG}" >/dev/null 2>&1 || gh release create "${TAG}" --generate-notes
          gh release upload "${TAG}" ./mjc-jm.apk ./update.json --clobber

# Required secrets:
# - ANDROID_KEYSTORE_BASE64: base64 of your .jks/.keystore file
# - ANDROID_KEYSTORE_PASSWORD
# - ANDROID_KEY_ALIAS
# - ANDROID_KEY_PASSWORD
